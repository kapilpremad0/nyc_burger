<div class="app-content content">
  <div class="content-overlay"></div>
  <div class="header-navbar-shadow"></div>
  <div class="content-wrapper container-xxl p-0">
    <div class="content-header row"></div>
    <div class="content-body">

      <div class="col-xl-12 col-lg-12">
        <form id="submitForm" method="post" enctype="multipart/form-data">
          <!-- hidden field to detect edit mode -->
          <input type="hidden" id="user_id" name="user_id" value="<%= user ? user._id : '' %>">

          <div class="card">
            <div class="card-header">
              <h3> <%= user ? 'Edit User' : 'Create User' %></h3>
            </div>
            <div class="card-body">
              <div class="row">

                <!-- Name -->
                <div class="mb-1 col-md-6">
                  <label for="name">Name</label>
                  <input type="text" class="form-control" id="name" name="name" value="<%= user ? user.name : '' %>" placeholder="Enter full name" />
                  <div id="name-submit_errors" class="validation-error"></div>
                </div>

                <!-- Email -->
                <div class="mb-1 col-md-6">
                  <label for="email">Email</label>
                  <input type="email" class="form-control" id="email" name="email" value="<%= user ? user.email : '' %>" placeholder="Enter email address" />
                  <div id="email-submit_errors" class="validation-error"></div>
                </div>

                <!-- Mobile -->
                <div class="mb-1 col-md-6">
                  <label for="mobile">Mobile</label>
                  <input type="text" class="form-control" id="mobile" name="mobile" value="<%= user ? user.mobile : '' %>" placeholder="Enter mobile number" />
                  <div id="mobile-submit_errors" class="validation-error"></div>
                </div>

                <!-- Password -->
                <div class="mb-1 col-md-6">
                  <label for="password">Password</label>
                  <input type="password" class="form-control" id="password" name="password" placeholder="Enter password" />
                  <div id="password-submit_errors" class="validation-error"></div>
                </div>

                <!-- Gender -->
                <div class="mb-1 col-md-6">
                  <label for="gender">Gender</label>
                  <select class="form-control" id="gender" name="gender">
                    <option value="">Select gender</option>
                    <option value="male" <%= user && user.gender === 'male' ? 'selected' : '' %>>Male</option>
                    <option value="female" <%= user && user.gender === 'female' ? 'selected' : '' %>>Female</option>
                    <option value="other" <%= user && user.gender === 'other' ? 'selected' : '' %>>Other</option>
                  </select>
                  <div id="gender-submit_errors" class="validation-error"></div>
                </div>

                <!-- DOB -->
                <div class="mb-1 col-md-6">
                  <label for="dob">Date of Birth</label>
                  <input type="date" class="form-control" id="dob" name="dob" value="<%= user ? user.dob_formatted : '' %>" />
                  <div id="dob-submit_errors" class="validation-error"></div>
                </div>

                <!-- Profile Image -->
                <div class="mb-1 col-md-6">
                  <label for="profile">Profile Image</label>
                  <input type="file" class="form-control" id="profile" name="profile" />
                  <% if (user && user.profile_url) { %>
                  <img src="<%= user.profile_url %>" alt="Profile" width="50" class="mt-1 rounded" />
                  <% } %>
                  <div id="profile-submit_errors" class="validation-error"></div>
                </div>

                <div class="mb-1 col-md-6">
                  <label for="branch">Branch</label>
                  <select class="form-select select2" id="branch" name="branch" required>
                    <option value="">Select Branch</option>
                    <% branches.forEach(branch => { %>
                    <option value="<%= branch._id %>" <%= user && user.branch && user.branch.toString() === branch._id.toString() ? 'selected' : '' %>>
                      <%= branch.name %> (<%= branch.city.name %>)
                    </option>
                    <% }) %>
                  </select>
                  <div id="branch-submit_errors" class="validation-error"></div>
                </div>

                <!-- Home Address -->
                <div class="mb-1 col-md-6">
                  <label for="homeAddress">Home Address</label>
                  <textarea class="form-control" id="homeAddress" name="homeAddress" placeholder="Enter home address"><%= user ? user.homeAddress : '' %></textarea>
                  <div id="homeAddress-submit_errors" class="validation-error"></div>
                </div>

                <!-- Branch Selection -->



                <div class="mb-1 col-md-12">
                  <!-- <h4>Staff Permissions</h4> -->
                  <% for (const module in permissionsConfig) { %>
                  <div class="mb-2">
                    <strong><%= module.charAt(0).toUpperCase() + module.slice(1) %> Permissions:</strong><br />
                    <% permissionsConfig[module].forEach(action => { %>
                    <label class="me-2">
                      <input type="checkbox" name="permissions[<%= module %>][]" value="<%= action %>" <%= user && user.permissions && user.permissions[module] && user.permissions[module].includes(action) ? 'checked' : '' %> />
                      <%= action.charAt(0).toUpperCase() + action.slice(1) %>
                    </label>
                    <% }) %>
                  </div>
                  <% } %>
                </div>

              </div>

              <!-- Submit -->
              <button type="submit" class="btn btn-primary mt-2">
                <%= user ? 'Update User' : 'Save User' %>
              </button>
            </div>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>


<script>
  $(document).ready(function() {
    $('#submitForm').on('submit', function(e) {
      e.preventDefault();
      $('.validation-error').text('');

      const formData = new FormData(this);
      const userId = $('#user_id').val();

      let url = '/admin/users';
      let method = 'POST';

      if (userId) { // editing
        url = '/admin/users/' + userId;
        method = 'PUT';
      }


      $('#form-loader').show();
      $.ajax({
        url: url,
        method: method,
        data: formData,
        processData: false,
        contentType: false,

        success: function(response) {
          $('#form-loader').hide();
          window.location.href = '/admin/users'; // redirect after save
        },
        error: function(res) {
          if (res.status == 400 || res.status == 422) {
            if (res.responseJSON && res.responseJSON.errors) {
              var error = res.responseJSON.errors;
              $.each(error, function(key, value) {
                $("#" + key + "-submit_errors").text(value);
              });
            }
          }
          if (res.status == 500) {
            showErrorToast(res.responseJSON.error);
          }
          if (res.status == 404) {
            showErrorToast('Something went worng');

          }
          $('#form-loader').hide();
        }
      });
    });
  });
</script>